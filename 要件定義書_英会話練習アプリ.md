## 要件定義書　# 英会話練習アプリ（音声対応）簡易要件定義書

## 1. プロジェクト概要

### 1.1 目的
OpenAI と LangChain を用いて、音声入出力に対応した英会話学習（会話・シャドーイング・ディクテーション）を手軽に反復練習できるシンプルな Web アプリを開発する。

### 1.2 スコープ
- Web UI（Streamlit）での対話・練習機能
- 音声録音（ブラウザ）とテキスト化（STT）の自動処理
- LLM による応答生成・課題文生成・評価生成
- 音声合成（TTS）での読み上げと速度変更

## 2. フィーチャ要件

### 2.1 モード管理
- **日常英会話**: ユーザーが話した英語を文字起こしし、LLM が自然な応答を返す
- **シャドーイング**: LLM が英文を生成・音声読み上げ → ユーザーが復唱 → 簡易評価
- **ディクテーション**: LLM が英文を生成・音声読み上げ → ユーザーが聞き取り入力 → 簡易評価

### 2.2 入出力
- **入力**: ブラウザ内録音（audio-recorder-streamlit）/ テキスト（ディクテーション）
- **処理**:
  - 文字起こし（STT）: gpt-4o-transcribe
  - 会話履歴管理: ConversationSummaryBufferMemory
  - LLM 応答/課題/評価生成: ConversationChain + プロンプト
- **出力**:
  - テキスト応答 / 課題文 / 評価コメント
  - 音声合成（TTS）: tts-1 / tts-1-hd、再生速度変更対応

### 2.3 基本設定
- **LLM モデル**: GPT-4o-mini（langchain-openai）
- **音声認識**: gpt-4o-transcribe
- **音声合成**: tts-1 or tts-1-hd（voice: alloy）
- **再生速度**: [2.0, 1.5, 1.2, 1.0, 0.8, 0.6]
- **英語レベル**: 初級者/中級者/上級者（UI 選択）

## 3. 技術仕様

### 3.1 必須コンポーネント
- **主要ライブラリ**
  - streamlit, openai, langchain, langchain-openai
  - pydub, audio-recorder-streamlit, PyAudio, scipy
  - python-dotenv

### 3.2 基本アーキテクチャ
ユーザー操作（録音/入力）
↓
音声 → 文字起こし（STT）
↓
LLM による応答/課題/評価生成（会話履歴あり）
↓
音声合成（TTS）
↓
ブラウザで再生 + ダウンロード提供

### 3.3 ディレクトリ構造（本リポジトリ）
project/
├── main.py                 # Streamlit メインアプリ
├── functions.py            # 音声処理・Chain 作成・再生ユーティリティ
├── constants.py            # 定数・プロンプトテンプレート
├── images/                 # アイコン（AI/ユーザー）
├── audio/                  # 入出力音声フォルダ（input/output）
├── .env                    # API キー（ローカル）※デプロイ時は secrets
├── requirements.txt        # 依存ライブラリ
└── README.md

## 4. 実装要件

### 4.1 初期化処理
- 環境変数ロード（dotenv / st.secrets フォールバック）
- OpenAI クライアント初期化（OpenAI）
- LLM 初期化（ChatOpenAI(model_name="gpt-4o-mini")）
- 会話メモリ初期化（ConversationSummaryBufferMemory）
- 各モード用 Chain 準備（基本会話、課題生成、評価）

### 4.2 モード別処理
1. **日常英会話**: 録音 → STT → LLM 応答 → TTS → 再生 → 履歴保存
2. **シャドーイング**: 課題文生成 → TTS → 録音 → STT → 簡易評価生成 → 表示
3. **ディクテーション**: 課題文生成 → TTS → ユーザーがテキスト入力 → 簡易評価生成 → 表示

### 4.3 エラーハンドリング
- API キー未設定時: 警告表示（st.secrets/.env 確認）
- マイク未認可/録音無: UI で処理停止（st.stop）
- STT/TTS/LLM API エラー: スピナー中断と通知
- 録音/一時ファイル: 不要ファイルの確実な削除

## 5. 動作要件

### 5.1 環境要件
- Python 3.11 以上（本プロジェクトは 3.11 想定）
- OpenAI API キー
- FFmpeg インストール（pydub の変換で使用）
- マイク入力可能なブラウザ
- 1GB 以上のメモリ / 1GB 以上のストレージ（音声一時ファイル用の目安）

### 5.2 制限事項
- 同時実行は 1 セッション想定（Streamlit のセッション境界）
- 録音はブラウザ UI 依存（モバイルでは制約の可能性）
- 長文オーディオは変換時間が長くなる場合あり
- 外部ナレッジ（RAG/ベクトル検索）は本要件に含めない（現状未実装）

---

### 付録: 使用モデル/エンドポイント（実装準拠）
- STT: audio.transcriptions.create(model="gpt-4o-transcribe")
- TTS: audio.speech.create(model="tts-1" | "tts-1-hd", voice="alloy")
- Chat: ChatOpenAI(model_name="gpt-4o-mini") + ConversationChain
